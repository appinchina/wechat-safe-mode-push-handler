# WeChat Push Notification Handler

A FastAPI-based server for handling WeChat push notifications with official encryption support.

## Overview

This application handles WeChat push notifications using the official WeChat encryption protocol. It has been updated to use the official `WXBizMsgCrypt` implementation from WeChat's Python SDK for better compatibility and reliability.

## Key Features

- **Official WeChat Encryption**: Uses the official `WXBizMsgCrypt` implementation
- **Security Mode Support**: Handles both encrypted and non-encrypted messages
- **Signature Verification**: Validates message authenticity using SHA1 signatures
- **FastAPI Framework**: Modern, fast web framework with automatic API documentation
- **Comprehensive Logging**: Detailed logging for debugging and monitoring

## Installation

1. Install the required dependencies:
```bash
pip install fastapi uvicorn pycryptodome
```

2. Configure your WeChat credentials in `app.py`:
```python
WECHAT_TOKEN = "YOUR_WECHAT_TOKEN_HERE"
WECHAT_ENCODING_AES_KEY = "YOUR_ENCODING_AES_KEY_HERE"  # 43 characters
WECHAT_APPID = "YOUR_APPID_HERE"
```

## Configuration

### WeChat Configuration

1. **Token**: Set in your WeChat Official Account settings
2. **EncodingAESKey**: 43-character key for encryption (auto-generated by WeChat)
3. **AppID**: Your WeChat Official Account AppID

### Security Mode

The application supports both security modes:
- **Plain Mode**: Messages are sent without encryption
- **Security Mode**: Messages are encrypted using AES-256-CBC

## API Endpoints

### GET /wechat
WeChat server verification endpoint.

**Parameters:**
- `signature`: SHA1 signature
- `timestamp`: Timestamp
- `nonce`: Random string
- `echostr`: Echo string to return

**Response:** Returns the `echostr` if signature verification passes.

### POST /wechat
Receives WeChat push notifications.

**Query Parameters:**
- `signature`: SHA1 signature (for plain mode)
- `timestamp`: Timestamp
- `nonce`: Random string
- `msg_signature`: Message signature (for security mode)
- `encrypt_type`: Encryption type ("aes" for security mode)

**Request Body:** JSON or encrypted XML message

**Response:** JSON response (encrypted in security mode)

## Encryption Implementation

The application uses the official WeChat encryption protocol:

### Encryption Process
1. **Random String**: Add 16-byte random string
2. **Message Length**: Add 4-byte network byte order length
3. **AppID**: Append AppID at the end
4. **PKCS7 Padding**: Pad to 32-byte blocks
5. **AES-CBC Encryption**: Use key as both encryption key and IV
6. **Base64 Encoding**: Encode the result

### Decryption Process
1. **Base64 Decoding**: Decode ciphertext
2. **AES-CBC Decryption**: Decrypt using key
3. **Remove Padding**: Remove PKCS7 padding
4. **Extract Components**: Parse message length, content, and AppID
5. **Validate AppID**: Ensure message comes from correct source

## Usage

### Running the Server

```bash
python app.py
```

The server will start on `http://127.0.0.1:8020`

### Testing

Use the provided test script to verify encryption/decryption:

```bash
python test_encryption.py
```

**Note:** Update the configuration variables in the test script with your actual WeChat credentials.

## File Structure

```
├── app.py                 # Main FastAPI application
├── test_encryption.py     # Test script for encryption/decryption
├── Python/
│   ├── WXBizMsgCrypt.py   # Official WeChat encryption implementation
│   ├── ierror.py          # Error codes
│   ├── Sample.py          # Usage examples
│   └── __init__.py
└── README.md              # This file
```

## Error Handling

The application includes comprehensive error handling with specific error codes:

- `WXBizMsgCrypt_OK`: Success
- `WXBizMsgCrypt_ValidateSignature_Error`: Invalid signature
- `WXBizMsgCrypt_ParseXml_Error`: XML parsing error
- `WXBizMsgCrypt_ComputeSignature_Error`: Signature computation error
- `WXBizMsgCrypt_IllegalAesKey`: Invalid AES key
- `WXBizMsgCrypt_ValidateAppid_Error`: AppID validation error
- `WXBizMsgCrypt_EncryptAES_Error`: Encryption error
- `WXBizMsgCrypt_DecryptAES_Error`: Decryption error
- `WXBizMsgCrypt_IllegalBuffer`: Invalid buffer
- `WXBizMsgCrypt_EncodeBase64_Error`: Base64 encoding error
- `WXBizMsgCrypt_DecodeBase64_Error`: Base64 decoding error
- `WXBizMsgCrypt_GenReturnXml_Error`: XML generation error

## Security Considerations

1. **Keep Credentials Secure**: Never commit your actual WeChat credentials to version control
2. **Use HTTPS**: Always use HTTPS in production
3. **Validate Signatures**: Always verify message signatures
4. **Check Timestamps**: Implement timestamp validation to prevent replay attacks
5. **Log Security Events**: Monitor and log security-related events

## Troubleshooting

### Common Issues

1. **Import Error for Crypto**: Install `pycryptodome` instead of `pycrypto`
2. **Invalid AES Key**: Ensure your EncodingAESKey is exactly 43 characters
3. **Signature Verification Failed**: Check that your Token matches WeChat settings
4. **AppID Mismatch**: Verify your AppID is correct

### Debug Mode

Enable debug logging by changing the log level:

```python
logging.basicConfig(level=logging.DEBUG)
```

## License

This project uses the official WeChat encryption implementation which is subject to WeChat's terms of service.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## Support

For issues related to WeChat's encryption protocol, refer to the official WeChat documentation. For application-specific issues, please open an issue in this repository. 